---
import Layout from "@/layouts/Layout.astro";
import SingleWeatherCard from "@/components/SingleWeatherCard.astro";
import WeatherChart from "@/components/WeatherChart.jsx";
import {
	IconSunrise,
	IconSunset,
	IconTemperaturePlus,
	IconTemperatureMinus,
	IconWindsockFilled,
	IconDroplet,
	IconGauge,
	IconUvIndex,
	IconBinoculars,
	IconCloud,
	IconRefresh,
	IconReload,
} from "@tabler/icons-react";

const env = import.meta.env;
const latCookie = Astro.cookies.get("lat");
const lonCookie = Astro.cookies.get("lon");
const cityCookie = Astro.cookies.get("city");

const lat = latCookie?.value;
const lon = lonCookie?.value;
const city = cityCookie?.value;

if (!lat || !lon) {
	return Astro.redirect("/setup");
}

let res = await fetch(
	`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&lang=DE&units=metric&appid=${env.OPENWEATHERMAP_API_KEY}`
);
const currentWeather = await res.json();

const time = new Date();
const currentDate = time.toLocaleDateString("de-DE", {
	timeZone: "Europe/Berlin",
	weekday: "long",
	month: "long",
	day: "numeric",
	hour: "2-digit",
	minute: "2-digit",
	hour12: false,
});

res = await fetch(
	`https://api.openweathermap.org/data/2.5/forecast/daily?lat=${lat}&lon=${lon}&cnt=8&lang=DE&units=metric&appid=${env.OPENWEATHERMAP_API_KEY}`
);
const weeklyWeather = await res.json();

res = await fetch(
	`https://api.openweathermap.org/data/2.5/forecast/hourly?lat=${lat}&lon=${lon}&cnt=24&lang=DE&units=metric&appid=${env.OPENWEATHERMAP_API_KEY}`
);
const hourlyWeather = await res.json();

const hourlyChartLabels = hourlyWeather.list.map((h) =>
	formatToBerlinTime(h.dt)
);
const hourlyTemperatures = hourlyWeather.list.map((h) =>
	Math.round(h.main.temp)
);
const hourlyPrecipitation = hourlyWeather.list.map((h) => {
	if (h.rain) {
		return h.rain["1h"];
	} else {
		return 0;
	}
});

let oneCall;
try {
	res = await fetch(
		`https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&units=metric&appid=${env.OPENWEATHERMAPONECALL_API_KEY}`
	);
	oneCall = await res.json();
} catch (error) {
	const fs = await import("fs/promises");
	const data = await fs.readFile("src/assets/output.json", "utf-8");
	oneCall = JSON.parse(data);
}


const hourlyUVIndex = oneCall.hourly.slice(1, 25).map((h) => {
	if (h.uvi) {
		return Math.round(h.uvi);
	} else {
		return 0;
	}
});

function formatToBerlinTime(unixTimestamp) {
	const date = new Date(unixTimestamp * 1000); // Convert to ms
	return date.toLocaleTimeString("de-DE", {
		timeZone: "Europe/Berlin",
		hour: "2-digit",
		minute: "2-digit",
		hour12: false,
	});
}

function formatToBerlinDate(unixTimestamp) {
	const date = new Date(unixTimestamp * 1000); // Convert to ms
	return date.toLocaleDateString("de-DE", {
		timeZone: "Europe/Berlin",
		weekday: "short",
	});
}

function meterToKm(m) {
	return m / 1000;
}

// some random color stuff
const hour = new Date().toLocaleTimeString("de-DE", {
	timeZone: "Europe/Berlin",
	hour: "2-digit",
	hour12: false,
});
const hourNumber = parseInt(hour, 10);
const isNight = hourNumber >= 22 || hourNumber < 6;
const colors = [
	"text-red-950",
	"text-orange-950",
	"text-amber-950",
	"text-yellow-950",
	"text-lime-950",
	"text-green-950",
	"text-emerald-950",
	"text-teal-950",
	"text-cyan-950",
	"text-sky-950",
	"text-blue-950",
	"text-indigo-950",
	"text-violet-950",
	"text-purple-950",
	"text-fuchsia-950",
	"text-pink-950",
	"text-rose-950",
	"text-slate-950",
	"text-gray-950",
	"text-zinc-950",
	"text-neutral-950",
	"text-stone-950",
];
const darkColors = [
	"text-red-100",
	"text-orange-100",
	"text-amber-100",
	"text-yellow-100",
	"text-lime-100",
	"text-green-100",
	"text-emerald-100",
	"text-teal-100",
	"text-cyan-100",
	"text-sky-100",
	"text-blue-100",
	"text-indigo-100",
	"text-violet-100",
	"text-purple-100",
	"text-fuchsia-100",
	"text-pink-100",
	"text-rose-100",
	"text-slate-100",
	"text-gray-100",
	"text-zinc-100",
	"text-neutral-100",
	"text-stone-100",
];
---

<Layout>
	<main
		class="flex flex-col items-center h-screen w-full"
		style={{
			backgroundColor: isNight ? "#111927" : "#fdfdfd",
			backgroundImage: isNight
				? `radial-gradient(at 50% 50%, hsl(200, 77%, 50%) 0px, transparent 59%),
         radial-gradient(at 82% 65%, hsl(218, 39%, 11%) 0px, transparent 55%)`
				: `radial-gradient(at 50% 50%, hsl(45, 100%, 80%) 0px, transparent 59%),
         radial-gradient(at 82% 65%, #f5f5f4 0px, transparent 55%)`,
		}}>
		<div class="flex flex-col gap-4 w-full">
			<section
				class="grid grid-cols-2 max-w-[1475px] items-center gap-4 mt-5 mx-auto">
				<div
					class:list={[
						"flex items-center gap-16 shadow-md rounded-lg p-8 backdrop-blur-lg backdrop-saturate-150 border h-full",
						{
							[`bg-[rgba(17,25,39,0.5)] border-white/10 text-slate-100`]:
								// ${darkColors[Math.floor(Math.random() * colors.length)]}
								isNight,
							[`bg-[rgba(245,245,244,0.75)] border-black/10 text-slate-900`]:
								//  ${colors[Math.floor(Math.random() * colors.length)]}
								!isNight,
						},
					]}>
					<div class="flex flex-col items-center">
						<div class="text-2xl font-bold">
							{city ? city : currentWeather.name}
						</div>
						<div class="text-xl font-semibold">
							{currentDate}
						</div>
						<img
							class="size-100 drop-shadow-md object-contain -my-24"
							src=`https://openweathermap.org/img/wn/${currentWeather.weather[0].icon}@4x.png`
						/>
						<p class="text-4xl font-semibold text-center">
							{currentWeather.weather[0].description}
						</p>
					</div>
					<div
						class="flex flex-col items-center justify-evenly self-stretch pr-8 -ml-8 text-center">
						<div class="ml-8 pb-4">
							<p class="text-9xl font-semibold">
								{Math.round(currentWeather.main.temp)}°C
							</p>
							<p
								class="text-4xl font-semibold flex items-baseline gap-2">
								Gefühlt:
								<span class="text-5xl font-semibold">
									{
										Math.round(
											currentWeather.main.feels_like
										)
									}°C
								</span>
							</p>
						</div>
						<div
							class="grid grid-cols-2 text-xl gap-x-8 font-semibold">
							<div class="flex items-end gap-4">
								<span><IconTemperatureMinus size={60} /></span>
								<div
									class="flex flex-col justify-center items-center w-full">
									Min:
									<span class="text-4xl font-bold">
										{
											Math.round(
												weeklyWeather.list[0].temp.min
											)
										}<span class="text-2xl">°C</span>
									</span>
								</div>
							</div>
							<div class="flex items-end gap-4">
								<span><IconTemperaturePlus size={60} /></span>
								<div
									class="flex flex-col justify-center items-center w-full">
									Max:
									<span class="text-4xl font-bold">
										{
											Math.round(
												weeklyWeather.list[0].temp.max
											)
										}<span class="text-2xl">°C</span>
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div
					class:list={[
						"grid grid-cols-2 grid-rows-4 text-lg font-semibold gap-x-16 gap-y-4 shadow-md rounded-lg p-8 backdrop-blur-lg backdrop-saturate-150 border pl-24 h-full text-center",
						{
							[`bg-[rgba(17,25,39,0.5)] border-white/10 text-slate-100`]:
								// ${darkColors[Math.floor(Math.random() * colors.length)]}
								isNight,
							[`bg-[rgba(245,245,244,0.75)] border-black/10 text-slate-900`]:
								//  ${colors[Math.floor(Math.random() * colors.length)]}
								!isNight,
						},
					]}>
					<div class="flex items-end">
						<span><IconSunrise size={60} /></span>
						<div
							class="flex flex-col justify-center items-center w-full">
							Sonnenaufgang:
							<span class="text-4xl font-bold">
								{formatToBerlinTime(currentWeather.sys.sunrise)}
							</span>
						</div>
					</div>
					<div class="flex items-end">
						<span><IconSunset size={60} /></span>
						<div
							class="flex flex-col justify-center items-center w-full">
							Sonnenuntergang:
							<span class="text-4xl font-bold">
								{formatToBerlinTime(currentWeather.sys.sunset)}
							</span>
						</div>
					</div>
					<div class="flex items-end">
						<span><IconWindsockFilled size={60} /></span>
						<div
							class="flex flex-col justify-center items-center w-full">
							Wind:
							<span class="text-4xl font-bold">
								{currentWeather.wind.speed}<span
									class="text-2xl">m/s</span
								>
							</span>
						</div>
					</div>
					<div class="flex items-end">
						<span><IconDroplet size={60} /></span>
						<div
							class="flex flex-col justify-center items-center w-full">
							Luftfeuchtigkeit:
							<span class="text-4xl font-bold">
								{currentWeather.main.humidity}<span
									class="text-2xl">%</span
								>
							</span>
						</div>
					</div>
					<div class="flex items-end">
						<span><IconGauge size={60} /></span>
						<div
							class="flex flex-col justify-center items-center w-full">
							Luftdruck:
							<span class="text-4xl font-bold">
								{currentWeather.main.pressure}<span
									class="text-2xl">hPa</span
								>
							</span>
						</div>
					</div>
					<div class="flex items-end">
						<span><IconUvIndex size={60} /></span>
						<div
							class="flex flex-col justify-center items-center w-full">
							UV-Index:
							<span
								class:list={[
									"text-4xl font-bold",
									{
										"text-red-600":
											oneCall.current.uvi >= 11,
										"text-red-400":
											oneCall.current.uvi >= 8,
										"text-orange-500":
											oneCall.current.uvi >= 6,
										"text-yellow-500":
											oneCall.current.uvi >= 3,
									},
								]}>
								{Math.round(oneCall.current.uvi)}
							</span>
						</div>
					</div>
					<div class="flex items-end">
						<span><IconBinoculars size={60} /></span>
						<div
							class="flex flex-col justify-center items-center w-full">
							Sicht:
							<span class="text-4xl font-bold">
								{meterToKm(currentWeather.visibility)}<span
									class="text-2xl">km</span
								>
							</span>
						</div>
					</div>
					<div class="flex items-end">
						<span><IconCloud size={60} /></span>
						<div
							class="flex flex-col justify-center items-center w-full">
							Wolken:
							<span class="text-4xl font-bold">
								{currentWeather.clouds.all}<span
									class="text-2xl">%</span
								>
							</span>
						</div>
					</div>
				</div>
			</section>

			<section
				class:list={[
					"w-full flex items-center justify-center shadow-md rounded-lg px-8 py-3 max-w-[1475px] mx-auto backdrop-blur-lg backdrop-saturate-150 border",
					{
						[`bg-[rgba(17,25,39,0.5)] border-white/10 ${darkColors[Math.floor(Math.random() * colors.length)]}`]:
							isNight,
						[`bg-[rgba(245,245,244,0.75)] border-black/10 ${colors[Math.floor(Math.random() * colors.length)]}`]:
							!isNight,
					},
				]}>
				<WeatherChart
					client:load
					labels={hourlyChartLabels}
					temperatureData={hourlyTemperatures}
					precipitationData={hourlyPrecipitation}
					uviData={hourlyUVIndex}
					sunrise={formatToBerlinTime(currentWeather.sys.sunrise)}
					sunset={formatToBerlinTime(currentWeather.sys.sunset)}
					textColor={isNight
						? darkColors[
								Math.floor(Math.random() * darkColors.length)
							]
						: colors[Math.floor(Math.random() * colors.length)]}
				/>
			</section>

			<section
				class:list={[
					"flex gap-4 justify-between w-[1475px] mx-auto shadow-md rounded-lg p-4 backdrop-blur-lg backdrop-saturate-150 border",
					{
						[`bg-[rgba(17,25,39,0.5)] border-white/10 ${darkColors[Math.floor(Math.random() * colors.length)]}`]:
							isNight,
						[`bg-[rgba(245,245,244,0.55)] border-black/10 ${colors[Math.floor(Math.random() * colors.length)]}`]:
							!isNight,
					},
				]}>
				{
					weeklyWeather.list
						.slice(1)
						.map((item) => (
							<SingleWeatherCard
								title={formatToBerlinDate(item.dt)}
								temperature={Math.round(item.temp.day)}
								icon={item.weather[0].icon}
								textColor={
									isNight
										? "text-slate-100"
										: "text-slate-900"
								}
							/>
						))
				}
			</section>
		</div>

		<p id="countdown" class="absolute left-4 bottom-4 text-slate-900">
			10:00
		</p>

		<script>
			let seconds = 600;
			const countdownEl = document.getElementById("countdown");
			function updateCountdown() {
				const min = Math.floor(seconds / 60);
				const sec = seconds % 60;
				countdownEl.textContent = `${min}:${sec.toString().padStart(2, "0")}`;
			}
			updateCountdown();
			const interval = setInterval(() => {
				seconds--;
				updateCountdown();
				if (seconds <= 0) {
					clearInterval(interval);
					window.location.reload();
					console.log("Reloading...");
				}
			}, 1000);
		</script>
	</main>
</Layout>
